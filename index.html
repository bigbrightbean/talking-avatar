<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Talking Avatar</title>
<style>
body {
  font-family: 'Comic Sans MS', Arial, sans-serif;
  text-align: center;
  background: #f0f8ff;
  padding: 40px;
}
h1 { color: #ff6600; margin-bottom: 30px; }
#avatar { width: 200px; margin-bottom: 20px; }
#text { font-size: 18px; margin-top: 20px; min-height: 60px; }

#talkBtn {
  font-size: 20px;
  padding: 20px 30px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  color: white;
  background: #4CAF50;
  box-shadow: 0 8px #666;
  transition: all 0.15s;
}
#talkBtn:active {
  box-shadow: 0 4px #444;
  transform: translateY(4px);
}
#talkBtn.orange { background: #FF9933; }
</style>
</head>
<body>

<h1>Talk to Me!</h1>
<img id="avatar" src="https://i.imgur.com/1X6R7Yx.png" alt="Avatar">

<button id="talkBtn">ðŸŽ¤ Talk</button>
<div id="text"></div>

<script>
const workerURL = "https://talking-avatar.bigbrightbean.workers.dev/";
const talkBtn = document.getElementById("talkBtn");
let recognizing = false;
let finalTranscript = "";
let recognition;

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if(!SpeechRecognition){
  alert("Your browser does not support SpeechRecognition. Please use Chrome or Edge.");
}

recognition = new SpeechRecognition();
recognition.lang = "en-US";
recognition.continuous = true; // Keep listening
recognition.interimResults = true;

recognition.onresult = function(event){
  let interimTranscript = "";
  for (let i = event.resultIndex; i < event.results.length; i++){
    if(event.results[i].isFinal){
      finalTranscript += event.results[i][0].transcript + " ";
    } else {
      interimTranscript += event.results[i][0].transcript;
    }
  }
  document.getElementById("text").innerText = "You are speaking: " + finalTranscript + interimTranscript;
};

recognition.onerror = function(event){
  console.error(event.error);
  alert("Microphone error: " + event.error);
  toggleRecording(false);
};

// --- key fix: auto-restart recognition on end ---
recognition.onend = function(){
  if(recognizing){
    recognition.start();
  }
};

function toggleRecording(start){
  if(start){
    recognizing = true;
    finalTranscript = "";
    talkBtn.classList.add("orange");
    talkBtn.innerText = "ðŸŽ¤ Recording...";
    recognition.start();
  } else {
    recognizing = false;
    talkBtn.classList.remove("orange");
    talkBtn.innerText = "ðŸŽ¤ Talk";
    recognition.stop(); // stop permanently
  }
}

talkBtn.addEventListener("click", async ()=>{
  if(!recognizing){
    toggleRecording(true);
  } else {
    toggleRecording(false);

    if(finalTranscript.trim().length === 0){
      document.getElementById("text").innerText = "You did not say anything!";
      return;
    }

    document.getElementById("text").innerText = "You said: " + finalTranscript + "\nThinking...";

    try{
      const response = await fetch(workerURL,{
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({text: finalTranscript})
      });
      const data = await response.json();
      document.getElementById("text").innerText = "Avatar says: " + data.reply;

      const utter = new SpeechSynthesisUtterance(data.reply);
      utter.rate = 0.9;
      utter.pitch = 1.1;
      speechSynthesis.speak(utter);

    } catch(err){
      console.error(err);
      document.getElementById("text").innerText = "Error connecting to AI.";
    }
  }
});
</script>

</body>
</html>
