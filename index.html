<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Talking Avatar</title>
<style>
body { font-family: 'Comic Sans MS', Arial, sans-serif; text-align: center; background: #f0f8ff; padding: 40px; }
h1 { color: #ff6600; margin-bottom: 30px; }
#avatar { width: 200px; margin-bottom: 20px; }
#text { font-size: 18px; margin-top: 20px; min-height: 60px; }
#talkBtn {
  font-size: 20px; padding: 20px 30px; border: none; border-radius: 50px;
  cursor: pointer; color: white; background: #4CAF50; box-shadow: 0 8px #666; transition: all 0.15s;
}
#talkBtn:active { box-shadow: 0 4px #444; transform: translateY(4px); }
#talkBtn.orange { background: #FF9933; }
</style>
</head>
<body>

<h1>Talk to Me!</h1>
<img id="avatar" src="https://i.imgur.com/1X6R7Yx.png" alt="Avatar">
<button id="talkBtn">ðŸŽ¤ Talk</button>
<div id="text"></div>

<script>
const workerURL = "https://talking-avatar.bigbrightbean.workers.dev/";
let talkBtn = document.getElementById("talkBtn");
let recognizing = false;
let mediaRecorder;
let audioChunks = [];

async function startRecording(){
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => {
    if(e.data.size > 0) audioChunks.push(e.data);
  };

  mediaRecorder.start();
  talkBtn.classList.add("orange");
  talkBtn.innerText = "ðŸŽ¤ Recording...";
}

async function stopRecording(){
  mediaRecorder.stop();
  talkBtn.classList.remove("orange");
  talkBtn.innerText = "ðŸŽ¤ Talk";

  const audioBlob = await new Promise(resolve => {
    mediaRecorder.onstop = () => resolve(new Blob(audioChunks, {type:'audio/webm'}));
  });

  document.getElementById("text").innerText = "Processing your speech...";

  try{
    const formData = new FormData();
    formData.append("file", audioBlob, "speech.webm");

    const response = await fetch(workerURL, { method: "POST", body: formData });
    const data = await response.json();

    document.getElementById("text").innerText = "Avatar says: " + data.reply;

    const utter = new SpeechSynthesisUtterance(data.reply);
    utter.rate = 0.9; utter.pitch = 1.1;
    speechSynthesis.speak(utter);

  } catch(err){
    console.error(err);
    document.getElementById("text").innerText = "Error connecting to AI.";
  }
}

talkBtn.addEventListener("click", async ()=>{
  if(!recognizing){
    recognizing = true;
    await startRecording();
  } else {
    recognizing = false;
    await stopRecording();
  }
});
</script>

</body>
</html>
