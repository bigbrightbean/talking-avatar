<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Talking Avatar</title>
<style>
body { font-family: 'Comic Sans MS', Arial, sans-serif; text-align: center; background: #f0f8ff; padding: 40px; }
h1 { color: #ff6600; margin-bottom: 30px; }
#avatar { width: 200px; margin-bottom: 20px; }
#text { font-size: 18px; margin-top: 20px; min-height: 60px; }
#talkBtn {
  font-size: 20px; padding: 20px 30px; border: none; border-radius: 50px;
  cursor: pointer; color: white; background: #4CAF50; box-shadow: 0 8px #666; transition: all 0.15s;
}
#talkBtn:active { box-shadow: 0 4px #444; transform: translateY(4px); }
#talkBtn.orange { background: #FF9933; }
</style>
</head>
<body>

<h1>Talk to Me!</h1>
<img id="avatar" src="https://i.imgur.com/1X6R7Yx.png" alt="Avatar">
<button id="talkBtn">ðŸŽ¤ Talk</button>
<div id="text"></div>

<script>
const workerURL = "https://talking-avatar.bigbrightbean.workers.dev/";

const talkBtn = document.getElementById("talkBtn");
const textDiv = document.getElementById("text");
let recognizing = false;
let recognition;

// cross-browser
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

function startRecognition(){
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = true; // allows long recording

  recognition.onresult = event => {
    let transcript = "";
    for (let i = 0; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }
    textDiv.innerText = "You said: " + transcript;
  };

  recognition.onerror = event => {
    console.error(event);
    alert("Microphone error. Please try again.");
    stopRecognition();
  };

  recognition.start();
}

function stopRecognition(){
  if(recognition){
    recognition.stop();
    recognition = null;
  }
}

async function sendToAI(text){
  textDiv.innerText = "Thinking...";
  try {
    const resp = await fetch(workerURL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ text })
    });
    const data = await resp.json();
    textDiv.innerText = "Avatar says: " + data.reply;

    const utter = new SpeechSynthesisUtterance(data.reply);
    utter.rate = 0.9;
    utter.pitch = 1.1;
    speechSynthesis.speak(utter);

  } catch(err){
    console.error(err);
    textDiv.innerText = "Error contacting AI.";
  }
}

// toggle button
talkBtn.addEventListener("click", ()=>{
  if(!recognizing){
    recognizing = true;
    talkBtn.classList.add("orange");
    talkBtn.innerText = "ðŸŽ¤ Listening...";
    startRecognition();
  } else {
    recognizing = false;
    talkBtn.classList.remove("orange");
    talkBtn.innerText = "ðŸŽ¤ Talk";
    if(recognition){
      recognition.onresult = async event => {
        let transcript = "";
        for (let i = 0; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        textDiv.innerText = "You said: " + transcript;
        await sendToAI(transcript);
      };
      stopRecognition();
    }
  }
});
</script>

</body>
</html>
