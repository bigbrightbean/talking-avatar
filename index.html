<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Talking Avatar</title>
<style>
body {
  font-family: 'Comic Sans MS', Arial, sans-serif;
  text-align: center;
  background: #f0f8ff;
  padding: 40px;
}
h1 { color: #ff6600; margin-bottom: 30px; }
#avatar { width: 200px; margin-bottom: 20px; }
#text { font-size: 18px; margin-top: 20px; min-height: 60px; }
#talkBtn {
  font-size: 20px;
  padding: 20px 30px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  color: white;
  background: #4CAF50;
  box-shadow: 0 8px #666;
  transition: all 0.15s;
}
#talkBtn:active {
  box-shadow: 0 4px #444;
  transform: translateY(4px);
}
#talkBtn.orange { background: #FF9933; }
</style>
</head>
<body>

<h1>Talk to Me!</h1>
<img id="avatar" src="https://i.imgur.com/1X6R7Yx.png" alt="Avatar">

<button id="talkBtn">ðŸŽ¤ Talk</button>
<div id="text"></div>

<script>
const workerURL = "https://talking-avatar.bigbrightbean.workers.dev/"; // Your Worker URL

const talkBtn = document.getElementById("talkBtn");

talkBtn.addEventListener("click", () => {
  talkBtn.classList.add("orange");
  talkBtn.innerText = "ðŸŽ¤ Listening...";

  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US"; // default recording in English

  recognition.onresult = async function(event) {
    const studentText = event.results[0][0].transcript;
    document.getElementById("text").innerText = "You said: " + studentText + "\nThinking...";

    try {
      const response = await fetch(workerURL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({text: studentText})
      });
      const data = await response.json();

      // Expect ChatGPT reply to include language code like: lang:en|Hello
      let langCode = "en";
      let replyText = data.reply;

      if (data.reply.startsWith("lang:")) {
        const splitIndex = data.reply.indexOf("|");
        langCode = data.reply.substring(5, splitIndex).trim();
        replyText = data.reply.substring(splitIndex + 1).trim();
      }

      document.getElementById("text").innerText = "Avatar says: " + replyText;

      if(langCode.startsWith("en")) {
        // English â†’ browser TTS
        const utter = new SpeechSynthesisUtterance(replyText);
        utter.voice = speechSynthesis.getVoices().find(v => v.lang==="en-US") || null;
        utter.rate = 0.9; utter.pitch = 1.1;
        speechSynthesis.speak(utter);
      } else {
        // Non-English â†’ Google Translate TTS
        const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(replyText)}&tl=${langCode}&client=tw-ob`;
        const audio = new Audio(ttsUrl);
        audio.play();
      }

    } catch(err) {
      console.error(err);
      document.getElementById("text").innerText = "Error connecting to AI.";
    }
  };

  recognition.onend = () => {
    talkBtn.classList.remove("orange");
    talkBtn.innerText = "ðŸŽ¤ Talk";
  };

  recognition.onerror = () => {
    talkBtn.classList.remove("orange");
    talkBtn.innerText = "ðŸŽ¤ Talk";
    alert("Microphone error. Try again.");
  };

  recognition.start();
});
</script>
</body>
</html>
