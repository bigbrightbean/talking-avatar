<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Talking Avatar</title>

<style>
body {
  font-family: 'Comic Sans MS', Arial, sans-serif;
  text-align: center;
  background: #f0f8ff;
  padding: 40px;
}

h1 {
  color: #ff6600;
  margin-bottom: 30px;
}

#avatar {
  width: 220px;
  margin-bottom: 20px;
}

#text {
  font-size: 18px;
  margin-top: 20px;
  min-height: 80px;
}

#talkBtn, #btn1 {
  font-size: 20px;
  padding: 20px 30px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  color: white;
  background: #4CAF50;
  box-shadow: 0 8px #666;
  transition: all 0.15s;
  margin: 8px;
}

#talkBtn:active, #btn1:active {
  box-shadow: 0 4px #444;
  transform: translateY(4px);
}

.orange {
  background: #FF9933 !important;
}
</style>
</head>

<body>

<h1>Talk to Me!</h1>

<img id="avatar" src="images/teacher-mouth1.png" alt="Avatar">

<br>

<button id="talkBtn">üé§ Talk</button>
<br>
<button id="btn1">1Ô∏è‚É£ Fish</button>

<div id="text"></div>

<script>
const workerURL = "https://talking-avatar.bigbrightbean.workers.dev/";
const talkBtn = document.getElementById("talkBtn");
const btn1 = document.getElementById("btn1");
const textDiv = document.getElementById("text");
const avatar = document.getElementById("avatar");

let recognizing = false;
let transcripts = [];
let recognition;

// ---------- Speech Recognition ----------
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

function startRecognitionBatch() {
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = event => {
    let text = "";
    for (let i = 0; i < event.results.length; i++) {
      text += event.results[i][0].transcript + " ";
    }
    transcripts.push(text.trim());
    textDiv.innerText = "You said: " + transcripts.join(" ");
  };

  recognition.onerror = () => stopRecognition();

  recognition.onend = () => {
    if (recognizing) recognition.start();
  };

  recognition.start();
}

function stopRecognition() {
  if (recognition) {
    recognition.stop();
    recognition = null;
  }
}

// ---------- NATURAL TALKING AVATAR ----------
let mouthTimer = null;

function startAvatarTalking() {
  stopAvatarTalking();
  mouthTimer = setInterval(() => {
    const r = Math.random();
    if (r < 0.2) avatar.src = "images/teacher-mouth1.png";
    else if (r < 0.7) avatar.src = "images/teacher-mouth2.png";
    else avatar.src = "images/teacher-mouth3.png";
  }, 120 + Math.random() * 120);
}

function stopAvatarTalking() {
  clearInterval(mouthTimer);
  avatar.src = "images/teacher-mouth1.png";
}

// ---------- AUDIO QUEUE (TTS + FILES) ----------
let busySpeakingOrAudio = false;

function speakTTS(text) {
  return new Promise(resolve => {
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.9;
    utter.pitch = 1.1;

    utter.onstart = startAvatarTalking;
    utter.onend = () => { stopAvatarTalking(); resolve(); };
    utter.onerror = () => { stopAvatarTalking(); resolve(); };

    speechSynthesis.speak(utter);
  });
}

function playFile(src) {
  return new Promise(resolve => {
    const audio = new Audio(src);
    startAvatarTalking();
    audio.onended = () => { stopAvatarTalking(); resolve(); };
    audio.onerror = () => { stopAvatarTalking(); resolve(); };
    audio.play().catch(() => { stopAvatarTalking(); resolve(); });
  });
}

async function runQueue(tasks) {
  if (busySpeakingOrAudio) return;
  busySpeakingOrAudio = true;

  // Cancel any ongoing TTS before starting a new sequence
  try { speechSynthesis.cancel(); } catch(e) {}

  for (const task of tasks) {
    if (task.type === "tts") await speakTTS(task.text);
    if (task.type === "file") await playFile(task.src);
  }

  busySpeakingOrAudio = false;
}

// ---------- Send to AI ----------
async function callAI(text) {
  const resp = await fetch(workerURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text })
  });
  const data = await resp.json();
  return data.reply || "";
}

/* ======================
   FISH LESSON MODE
====================== */
// Adjust these paths if your files are named differently:
const F_SOUNDS = [
  "audio/phonemes/f.m4a",
  "audio/phonemes/i.m4a",
  "audio/phonemes/sh.m4a"
];
const F_WORD = "audio/words/fish.m4a";

let fishMode = false; // toggled by button 1

async function askFishQuestion() {
  const openingLines = [
    "Ooo! A secret sound mission! Let‚Äôs do some blending!",
    "Hi superstar! Ready for a quick sound puzzle?",
    "Okay! Teacher ears on! Let‚Äôs blend some sounds together!"
  ];
  const opening = openingLines[Math.floor(Math.random() * openingLines.length)];

  textDiv.innerText = "Miss Maggie: " + opening + "\nCan you blend these sounds?";

  await runQueue([
    { type: "tts", text: `${opening} Can you blend these sounds?` },
    { type: "file", src: F_SOUNDS[0] },
    { type: "file", src: F_SOUNDS[1] },
    { type: "file", src: F_SOUNDS[2] },
    { type: "tts", text: "What word does it make? Press Talk and tell me!" }
  ]);
}

// Button 1 toggles fish mode ON/OFF
btn1.addEventListener("click", async () => {
  fishMode = !fishMode;

  if (fishMode) {
    btn1.classList.add("orange");
    transcripts = [];
    await askFishQuestion();
  } else {
    btn1.classList.remove("orange");
    textDiv.innerText = "Miss Maggie: Okay! Back to free talk. Press Talk to chat!";
  }
});

// ---------- Talk Button Toggle ----------
talkBtn.addEventListener("click", () => {
  if (!recognizing) {
    recognizing = true;
    transcripts = [];
    talkBtn.classList.add("orange");
    talkBtn.innerText = "üé§ Listening...";
    startRecognitionBatch();
  } else {
    recognizing = false;
    talkBtn.classList.remove("orange");
    talkBtn.innerText = "üé§ Talk";
    stopRecognition();
    onStudentFinishedSpeaking();
  }
});

// ---------- When Student Finishes Speaking ----------
async function onStudentFinishedSpeaking() {
  const finalText = transcripts.join(" ").trim().toLowerCase();

  if (!finalText) {
    textDiv.innerText = "No speech detected.";
    return;
  }

  // ================= FISH MODE =================
  if (fishMode) {
    const isCorrect = finalText.includes("fish");

    const promptToAI = `
You are Miss Maggie, a warm playful kindergarten phonics teacher.
Rules:
- You do NOT judge pronunciation accuracy; only react to the correctness flag I provide.
- Never say "wrong". Be kind, funny, and encouraging.
- Reply in 1 to 4 sentences max.

Target word: fish
Student said: "${finalText}"
Correct flag: ${isCorrect ? "correct" : "not correct yet"}

If correct:
- Celebrate warmly and playful.
- Invite them to practice again or press 1 to exit.
If not correct yet:
- Encourage listening again and trying once more.
`;

    textDiv.innerText = "Thinking...";

    let reply = "Let‚Äôs listen and try again together!";
    try { reply = await callAI(promptToAI); } catch(e) {}

    textDiv.innerText = "Miss Maggie: " + reply;

    // Always: f i sh
    // If correct: fish twice
    // If not correct: NO fish (don‚Äôt give the answer)
    let queue = [
      { type: "tts", text: reply },
      { type: "file", src: F_SOUNDS[0] },
      { type: "file", src: F_SOUNDS[1] },
      { type: "file", src: F_SOUNDS[2] }
    ];

    if (isCorrect) {
      queue.push({ type: "file", src: F_WORD });
      queue.push({ type: "file", src: F_WORD }); // fish 2x total
      queue.push({
        type: "tts",
        text: "Nice! You can press Talk to practice again, or press 1 to go back to free talk."
      });
    } else {
      queue.push({
        type: "tts",
        text: "Good try! Listen again and try once more. Press Talk when you‚Äôre ready!"
      });
    }

    await runQueue(queue);

    // fishMode stays ON until toggled off
    return;
  }

  // ================= FREE TALK MODE =================
  textDiv.innerText = "Thinking...";

  try {
    const reply = await callAI(finalText);
    textDiv.innerText = "Avatar says: " + reply;

    await runQueue([{ type: "tts", text: reply }]);
  } catch (err) {
    textDiv.innerText = "Error contacting AI.";
  }
}

// Initial hint text
textDiv.innerText = "Miss Maggie: Press Talk to chat, or press 1Ô∏è‚É£ Fish to start blending!";
</script>

</body>
</html>
