<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Talking Avatar</title>

<style>
body {
  font-family: 'Comic Sans MS', Arial, sans-serif;
  text-align: center;
  background: #f0f8ff;
  padding: 40px;
}

h1 { color: #ff6600; margin-bottom: 30px; }

#avatar {
  width: 220px;
  margin-bottom: 20px;
}

.talking {
  animation: bounce 0.35s infinite alternate;
}

@keyframes bounce {
  from { transform: translateY(0); }
  to { transform: translateY(-6px); }
}

#text {
  font-size: 18px;
  margin-top: 20px;
  min-height: 60px;
}

#talkBtn {
  font-size: 20px;
  padding: 20px 30px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  color: white;
  background: #4CAF50;
  box-shadow: 0 8px #666;
  transition: all 0.15s;
}

#talkBtn:active {
  box-shadow: 0 4px #444;
  transform: translateY(4px);
}

#talkBtn.orange {
  background: #FF9933;
}
</style>
</head>

<body>

<h1>Talk to Me!</h1>

<img id="avatar" src="images/teacher-mouth1.png" alt="Avatar">

<button id="talkBtn">ðŸŽ¤ Talk</button>
<div id="text"></div>

<script>
const workerURL = "https://talking-avatar.bigbrightbean.workers.dev/";
const talkBtn = document.getElementById("talkBtn");
const textDiv = document.getElementById("text");
const avatar = document.getElementById("avatar");

/* =====================
   Avatar talking logic
===================== */
const mouthFrames = [
  "images/teacher-mouth1.png",
  "images/teacher-mouth2.png",
  "images/teacher-mouth3.png"
];

let mouthTimer = null;

function startAvatarTalking() {
  let i = 0;
  avatar.classList.add("talking");
  mouthTimer = setInterval(() => {
    avatar.src = mouthFrames[i % mouthFrames.length];
    i++;
  }, 150);
}

function stopAvatarTalking() {
  clearInterval(mouthTimer);
  avatar.classList.remove("talking");
  avatar.src = mouthFrames[0];
}

/* =====================
   Speech recognition
===================== */
let recognizing = false;
let transcripts = [];
let recognition;

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

function startRecognitionBatch() {
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = event => {
    let transcript = "";
    for (let i = 0; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript + " ";
    }
    transcripts.push(transcript.trim());
    textDiv.innerText = "You said: " + transcripts.join(" ");
  };

  recognition.onerror = () => {
    alert("Microphone error. Try again.");
    stopRecognition();
  };

  recognition.onend = () => {
    if (recognizing) recognition.start();
  };

  recognition.start();
}

function stopRecognition() {
  if (recognition) {
    recognition.stop();
    recognition = null;
  }
}

/* =====================
   Send to AI + speak
===================== */
async function sendToAI() {
  const finalText = transcripts.join(" ").trim();
  if (!finalText) {
    textDiv.innerText = "No speech detected.";
    return;
  }

  textDiv.innerText = "Thinking...";

  try {
    const resp = await fetch(workerURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: finalText })
    });

    const data = await resp.json();
    textDiv.innerText = "Avatar says: " + data.reply;

    const utter = new SpeechSynthesisUtterance(data.reply);
    utter.rate = 0.9;
    utter.pitch = 1.1;

    utter.onstart = () => startAvatarTalking();
    utter.onend = () => stopAvatarTalking();

    speechSynthesis.cancel();
    speechSynthesis.speak(utter);

  } catch (err) {
    console.error(err);
    textDiv.innerText = "Error contacting AI.";
  }
}

/* =====================
   Talk button toggle
===================== */
talkBtn.addEventListener("click", () => {
  if (!recognizing) {
    recognizing = true;
    transcripts = [];
    talkBtn.classList.add("orange");
    talkBtn.innerText = "ðŸŽ¤ Listening...";
    startRecognitionBatch();
  } else {
    recognizing = false;
    talkBtn.classList.remove("orange");
    talkBtn.innerText = "ðŸŽ¤ Talk";
    stopRecognition();
    sendToAI();
  }
});
</script>

</body>
</html>
